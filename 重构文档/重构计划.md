# AI Browser Tools 重构实施计划

## 重构目标

基于 `gpt-codex.md` 的架构设计，采用 **Service + Store + View** 模式，按模块逐步重构现有代码：

- 所有新代码统一放在 `src/newCode/` 下，与现有实现严格区分
- 通过 feature flag 控制新旧功能切换，降低风险
- 逐步迁移，保证每个阶段都有可验收的交付物

**参考 UI 设计截图**：

- `工作流 + 画布.png` - 完整布局视图
- `节点列表 + 画布.png` - 节点库面板
- `节点配置.png` - 节点配置面板
- `编辑器配置 + 画布.png` - 编辑器配置
- `代码编辑器.png` - 代码编辑器

---

## 实施阶段（阶段 → 任务 → 交付物）

### 阶段 0：目录结构与 UI Shell 迁移

**目标**：建立 `src/newCode/` 目录骨架，迁移现有 UI Shell 组件

**任务**：

- ✅ 创建 `src/newCode/` 目录结构（app、ui、features、services、stores、config 等）
- ✅ 将已创建的 `PanelShell`、`ModalShell` 迁移到 `src/newCode/ui/`
- ✅ 将 `UiShellPreview.vue` 迁移到 `src/newCode/views/`
- ✅ 更新路由引用新路径
- 在 `重构文档/` 中补充实施日志和目录说明

**交付物**：

- `src/newCode/` 完整目录结构
- UI Shell 组件迁移完成并可预览
- `重构文档/implementation-log.md`（实施日志）
- `重构文档/directory-structure.md`（目录结构说明）

---

### 阶段 1：Canvas 特性模块拆分

**目标**：拆分巨型 `NodeEditor.vue`，实现 Canvas 模块化

**任务**：

- 创建 `src/newCode/features/canvas/` 目录

  - `CanvasView.vue` - Canvas 主视图（基于 `工作流 + 画布.png`）
  - `CanvasStatsBar.vue` - 统计栏（节点数、边数、执行状态）
  - `QuickNodeMenu.vue` - 快捷节点菜单
  - `CanvasToolbar.vue` - 画布工具栏
  - `NodeResultPanel.vue` - 节点结果面板

- 创建 `src/newCode/services/canvasService.ts`

  - 封装 VueFlow 操作（缩放、自动布局、节点投影）
  - 快捷键管理
  - 容器拖拽逻辑
  - Ctrl 连线候选逻辑

- 创建 `src/newCode/stores/canvas.ts`（Pinia Store）
  - 维护节点、边、UI 状态
  - 选中信息管理
  - 通过服务事件更新执行状态（**移除轮询**）

**交付物**：

- 新的 Canvas 模块（feature flag 控制）
- 预览页面 `/preview/canvas`
- `重构文档/canvas-module.md`（Canvas 模块文档）

---

### 阶段 2：Workflow Tree & 变量模块

**目标**：重构工作流文件树和变量编辑器

**任务**：

- 创建 `src/newCode/services/workflowTreeService.ts`

  - 树结构 CRUD
  - 拖拽 result 计算
  - Drop Target 判定
  - 不可变更新

- 创建 `src/newCode/services/variableService.ts`

  - 变量上下文构建
  - 配置变量解析
  - 预览分页
  - 拖拽插入逻辑

- 创建 `src/newCode/features/workflow-tree/`（基于 `工作流 + 画布.png`）

  - `WorkflowTreePanel.vue` - 使用 `PanelShell`
  - `WorkflowTreeItem.vue` - 树节点项

- 创建 `src/newCode/features/variables/`
  - `VariableEditorModal.vue` - 使用 `ModalShell`
  - `VariablePreviewPanel.vue` - 变量预览

**交付物**：

- WorkflowTree 和 Variable 服务层
- 新的面板组件
- 数据迁移适配层
- `重构文档/workflow-tree-service.md`
- `重构文档/variable-service.md`

---

### 阶段 3：Node Library 模块

**目标**：重构节点列表面板（基于 `节点列表 + 画布.png`）

**任务**：

- 创建 `src/newCode/services/nodeRegistryService.ts`

  - 加载 & 缓存 metadata
  - 分类、搜索、推荐
  - 颜色映射
  - 支持热更新

- 创建 `src/newCode/features/node-library/`
  - `NodeLibraryPanel.vue` - 使用 `PanelShell`
  - `NodeCategoryAccordion.vue` - 分类折叠面板
  - `NodeLibraryItem.vue` - 节点项（支持拖拽）

**交付物**：

- NodeRegistry 服务层
- 新的节点列表面板
- 预览页面 `/preview/node-library`
- `重构文档/node-library-module.md`

---

### 阶段 4：Node Config 模块

**目标**：重构节点配置面板（基于 `节点配置.png`）

**任务**：

- 创建 `src/newCode/services/nodeConfigService.ts`

  - 根据 schema 生成配置表单
  - 校验规则
  - 默认值补齐
  - 配置变更与持久化

- 创建 `src/newCode/features/node-config/`

  - `NodeConfigPanel.vue` - 使用 `PanelShell`
  - `NodeConfigForm.vue` - 动态表单
  - `NodeConfigField.vue` - 表单字段组件

- 创建 `src/newCode/ui/form/`（通用表单组件）
  - `FormField.vue`
  - `FormInput.vue`
  - `FormSelect.vue`
  - `FormTextarea.vue`
  - `FormSwitch.vue`

**交付物**：

- NodeConfig 服务层
- 新的节点配置面板
- 通用表单组件库
- `重构文档/node-config-module.md`

---

### 阶段 5：Execution 统一服务

**目标**：统一 Worker / Server 执行模式，移除轮询

**任务**：

- 创建 `src/newCode/services/execution/`

  - `ExecutionService.ts` - 执行服务主入口
  - `WorkerAdapter.ts` - Worker 适配器
  - `ServerAdapter.ts` - Server 适配器
  - `executionProtocol.ts` - 执行协议定义

- 创建 `src/newCode/stores/execution.ts`

  - 维护 `executions`, `nodeStates`, `activeEdges`, `snapshots`
  - 通过事件流实时更新（**移除 setInterval 轮询**）

- 实现执行协议 v1（参考 `gpt-codex.md` 4.10）
  - `INIT`/`INIT_RESULT`（含 `protocolVersion`）
  - `EXECUTION_START`
  - `EXECUTION_EVENT`
  - `EXECUTION_ERROR`
  - `PING/PONG`（心跳）

**交付物**：

- ExecutionService 服务层
- Worker/Server 适配器
- Execution Store
- `重构文档/execution-service.md`
- `重构文档/execution-protocol.md`

---

### 阶段 6：Node Executor 模块化

**目标**：拆分 `packages/node-executor` 单体函数

**任务**：

- 在 `packages/node-executor/src/` 下拆分模块：

  - `GraphScheduler.ts` - 拓扑遍历、队列管理、循环帧
  - `ExecutionContextManager.ts` - 变量环境、循环变量
  - `ConfigResolver.ts` - 配置解析与变量替换
  - `ResultCollector.ts` - 日志、结果、快照记录
  - `HookSystem.ts` - 生命周期扩展点

- 重构 `executeWorkflow` 函数

  - 组合上述模块
  - 处理取消、异常上报、统计输出

- 补充单元测试（关键逻辑）

**交付物**：

- 模块化执行器
- For/If/循环 Hook
- 单元测试覆盖
- `重构文档/executor-modules.md`

---

### 阶段 7：节点定义流水线

**目标**：标准化节点定义，支持自动生成 metadata

**任务**：

- 引入 `createNodeDefinition` 函数式 API

  - 声明 meta、inputs、outputs、schema、运行逻辑

- 编写 CLI（`pnpm build:metadata`）

  - 聚合所有节点定义
  - 输出 JSON + d.ts

- 在 `packages/browser-nodes` 中迁移示例节点
  - 提供 BaseNode → Definition 适配器

**交付物**：

- `createNodeDefinition` API
- metadata 构建 CLI
- 示例节点迁移
- 兼容层
- `重构文档/node-definition-guide.md`

---

### 阶段 8：应用布局与预览

**目标**：重构应用布局，移除 iframe

**任务**：

- 创建 `src/newCode/app/`

  - `Layout.vue` - 主布局（基于 `工作流 + 画布.png`）
  - `Sidebar.vue` - 侧边栏
  - `TopBar.vue` - 顶部栏
  - `router.ts` - 新路由配置

- 创建多个预览视图：
  - `/preview/canvas` - Canvas 预览
  - `/preview/workflow-tree` - 工作流树预览
  - `/preview/node-library` - 节点列表预览
  - `/preview/node-config` - 节点配置预览
  - `/preview/modals` - 弹窗预览

**交付物**：

- 新布局系统
- 预览页面集合
- `重构文档/layout-design.md`

---

### 阶段 9：数据迁移与灰度

**目标**：实现数据版本化存储和迁移

**任务**：

- 创建 `src/newCode/services/persistence/`

  - `PersistenceService.ts` - 统一本地存储
  - `migrationScripts.ts` - 数据迁移脚本
  - `backupService.ts` - 备份与回滚

- 实现 feature flag 系统

  - 环境变量控制
  - 用户设置控制
  - 灰度开关

- 编写迁移脚本
  - 工作流数据迁移
  - 配置迁移
  - 历史记录迁移

**交付物**：

- Persistence 服务层
- 迁移脚本
- 备份恢复工具
- Feature flag 系统
- `重构文档/data-migration.md`

---

### 阶段 10：收尾与文档

**目标**：完善文档，验收交付

**任务**：

- 性能对比（旧版 vs 新版）

  - FPS 对比
  - 执行耗时对比
  - 初始加载时间对比

- 完善重构文档

  - 实施总结
  - 最终迁移说明
  - 已知问题与解决方案

- 清理临时代码和注释

**交付物**：

- `重构文档/performance-comparison.md`
- `重构文档/migration-guide.md`
- `重构文档/final-summary.md`

---

## 后续安排

### 当前状态（阶段 0 进行中）

- ✅ 已创建 `src/ui/` 目录和 UI Shell 组件
- ✅ 已创建 `src/views/UiShellPreview.vue` 预览页面
- ✅ 已更新路由

### 下一步行动

1. **迁移文件到 `src/newCode/` 目录**

   - 将 `src/ui/` → `src/newCode/ui/`
   - 将 `src/views/UiShellPreview.vue` → `src/newCode/views/UiShellPreview.vue`
   - 更新所有引用路径

2. **创建完整目录结构**

   - `src/newCode/app/`
   - `src/newCode/features/`
   - `src/newCode/services/`
   - `src/newCode/stores/`
   - `src/newCode/config/`

3. **补充实施文档**

   - `重构文档/implementation-log.md`
   - `重构文档/directory-structure.md`

4. **开始阶段 1：Canvas 模块拆分**

---

## 注意事项

- ⚠️ 所有新代码必须放在 `src/newCode/` 下
- ⚠️ 通过 feature flag 控制新旧功能切换
- ⚠️ 每个阶段完成后需更新实施日志
- ⚠️ 保持向后兼容，避免破坏现有功能
- ⚠️ 优先完成核心模块（UI Shell、Canvas、Execution）

---

## 风险与应对

| 风险              | 描述                           | 缓解措施                                     |
| ----------------- | ------------------------------ | -------------------------------------------- |
| 功能回退          | 大规模拆分可能导致关键功能失效 | 引入 feature flag，阶段性验收                |
| 数据迁移失败      | LocalStorage 数据结构改变      | 提供版本化迁移与回退策略                     |
| Worker 协议不兼容 | 老版本 Worker 与新前端冲突     | 在初始化阶段校验 `protocolVersion`，提示升级 |
| 开发冲突          | 多人协作修改同一区域           | 以功能为单位拆分，提前锁定修改范围           |

---

## 参考文档

- `重构文档/gpt-codex.md` - 完整架构设计
- `重构文档/*.png` - UI 设计截图
