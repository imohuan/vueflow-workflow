# AI Browser Tools 重构产品文档

> **文档版本**：v2.0  
> **更新日期**：2025-11-05  
> **负责人**：产品团队  
> **状态**：进行中

---

## 一、产品背景与问题分析

### 1.1 项目现状

AI Browser Tools 是一个基于可视化节点编辑器的工作流自动化工具，由以下核心部分组成：

- **前端编辑器**：基于 Vue 3 + VueFlow 的可视化节点编辑器
- **执行内核**：`packages/node-executor` 工作流执行引擎
- **节点集合**：`packages/browser-nodes` 浏览器自动化节点库
- **执行环境**：支持 Worker / Server 双模式

### 1.2 核心痛点

#### 技术债务层面

1. **巨型组件问题**：`NodeEditor.vue` 超过 2000 行，职责混乱
2. **状态管理混乱**：Store 承担过多职责，难以维护和测试
3. **UI 不一致**：缺乏统一的 UI 组件规范，样式分散
4. **执行轮询问题**：使用 `setInterval` 轮询状态，性能低下
5. **协议不统一**：Worker / Server 模式差异大，维护成本高

#### 用户体验层面

1. **交互不流畅**：状态轮询导致 UI 卡顿
2. **学习成本高**：UI 不一致，操作逻辑不清晰
3. **功能扩展困难**：添加新功能需要大量重复代码

### 1.3 原重构计划的问题

**原计划的主要问题**：

1. **过度工程化**：从 Shell 组件开始，缺乏可见的产品进展
2. **预览页面误导**：创建大量预览页面，而非真实可用的产品界面
3. **顺序不合理**：先做基础设施，后做产品功能，导致长期无法验证价值
4. **缺乏可用性验证**：每个阶段完成后无法形成完整的用户体验闭环

**核心矛盾**：  
开发者视角（技术架构优先） vs 产品视角（用户价值优先）

---

## 二、重构策略调整

### 2.1 新的重构原则

#### 原则 1：产品可用性优先

- ✅ 每个阶段交付完整可用的产品功能
- ✅ 优先构建核心用户体验
- ❌ 避免长时间的基础设施建设期

#### 原则 2：垂直切片交付

- ✅ 从 UI → 逻辑 → 数据 完整实现一个功能模块
- ✅ 快速验证可行性，及时调整方向
- ❌ 避免水平分层（先做完所有 UI，再做逻辑）

#### 原则 3：渐进式替换

- ✅ 新旧系统并存，通过 Feature Flag 控制
- ✅ 保持现有功能可用，逐步迁移
- ❌ 避免 "大爆炸" 式重构

#### 原则 4：用户反馈驱动

- ✅ 尽早提供可交互的界面
- ✅ 收集用户反馈，迭代优化
- ❌ 避免闭门造车

### 2.2 重构路线图

```
阶段 1：完整 UI 布局实现（当前阶段）
    ↓
阶段 2：核心画布逻辑实现
    ↓
阶段 3：配置系统与节点管理
    ↓
阶段 4：执行引擎重构
    ↓
阶段 5：数据迁移与优化
```

---

## 三、阶段 1：完整 UI 布局实现

### 3.1 产品目标

**核心目标**：构建一个完整、可交互的产品界面框架，为后续功能实现提供坚实基础。

**成功标准**：

- ✅ 用户可以看到完整的应用布局
- ✅ 所有主要面板可以打开、关闭、切换
- ✅ 界面交互流畅，符合用户预期
- ✅ 支持自定义测试功能，便于开发调试

### 3.2 UI 架构设计

#### 整体布局结构

```
┌────────────────────────────────────────────────────┐
│                 （无顶部标题栏）                    │
├───┬───────┬────────────────────────────────────────┤
│   │       │                                        │
│ 左│ 左侧  │          中央画布区域                   │
│ 侧│ 浮动  │                                        │
│ 导│ 面板  │                                        │
│ 航│       │                                        │
│ 栏│       │                                        │
│   │       │                                        │
│   │       │       底部工具栏（悬浮）                │
│   │       │                                        │
└───┴───────┴────────────────────────────────────────┘
```

#### 核心组件拆解

**1. 左侧导航栏（VerticalTabNav）**

```typescript
功能需求：
- 垂直排列的 Tab 按钮
- 支持图标 + 文字模式
- 激活状态高亮显示
- 可配置的 Tab 项列表

Tab 项定义：
- 工作流管理 🗂️
- 节点库 📦
- 变量管理 🔢
- 历史记录 📝
- 测试菜单 🧪（开发专用）
- 设置 ⚙️
```

**2. 左侧浮动面板（FloatingPanel）**

```typescript
位置说明：
- 位于左侧导航栏（VerticalTabNav）的右边
- 画布区域的左侧
- 悬浮在画布之上

功能需求：
- 可拖拽移动（可选，当前固定在左侧）
- 可调整大小（宽度 280-600px）
- 支持关闭/展开
- 支持多种尺寸预设（small/medium/large）
- 内容区域根据选中的 Tab 动态渲染

面板内容类型：
- 工作流树（Tree View）
- 节点列表（Grid/List View）
- 变量编辑器（Form View）
- 历史记录（Timeline View）
- 测试控制台（Custom View）
```

**3. 中央画布区域（CanvasView）**

```typescript
功能需求：
- VueFlow 节点编辑器容器
- 支持缩放、平移、框选
- 节点拖拽、连线
- 右键快捷菜单
- 执行状态可视化

视觉反馈：
- 节点执行状态（pending/running/success/error）
- 连线激活状态
- 选中状态高亮
- 悬停提示
```

**4. 底部工具栏（CanvasToolbar）**

```typescript
功能需求：
- 画布操作：缩放适应、自动布局、显示/隐藏小地图
- 执行控制：开始执行、停止执行、单步调试
- 视图切换：节点视图、结果视图
- 快捷键提示

布局：
- 悬浮在画布中央底部
- 半透明背景 + 毛玻璃效果
- 响应式布局，小屏幕时简化显示
```

**5. 测试菜单（TestMenu）** ⭐ 新增

```typescript
功能需求：
- 用于开发阶段的功能测试
- 快速触发各种 UI 组件和状态

测试项包含：
1. 弹窗测试
   - 打开 Modal 悬浮框（信息展示）
   - 打开全屏编辑器 Modal（代码编辑）
   - 打开确认对话框
   - 打开提示对话框

2. 面板测试
   - 切换面板尺寸（small/medium/large）
   - 测试面板拖拽
   - 测试面板关闭/重开

3. 画布测试
   - 添加测试节点
   - 模拟执行流程
   - 测试节点连线
   - 清空画布

4. 数据测试
   - 加载示例工作流
   - 导出画布数据
   - 重置所有状态

5. UI 状态测试
   - 切换主题（亮色/暗色）
   - 测试加载状态
   - 测试错误状态
   - 测试空状态
```

### 3.3 详细实现方案

#### 任务 1：增强 VerticalTabNav 组件

**目标**：实现完整的侧边栏导航功能

**实现要点**：

```typescript
// Tab 项配置接口
interface TabItem {
  id: string; // 唯一标识
  label: string; // 显示文字
  icon: Component; // 图标组件
  badge?: number; // 角标数字
  disabled?: boolean; // 是否禁用
  testOnly?: boolean; // 是否仅测试环境显示
}

// Tab 配置列表
const tabs: TabItem[] = [
  { id: "workflow", label: "工作流", icon: IconFolder },
  { id: "nodes", label: "节点库", icon: IconGrid },
  { id: "variables", label: "变量", icon: IconCode },
  { id: "history", label: "历史", icon: IconClock },
  { id: "test", label: "测试", icon: IconFlask, testOnly: true },
  { id: "settings", label: "设置", icon: IconSettings },
];
```

**交互行为**：

- 点击 Tab 切换激活状态
- 再次点击已激活的 Tab 关闭浮动面板
- 未激活 Tab 点击打开对应面板
- 支持键盘导航（上下方向键切换）

**视觉设计**：

- 激活状态：主题色背景 + 白色图标
- 未激活状态：透明背景 + 灰色图标
- 悬停状态：浅色背景
- 角标：红色圆点，显示数字

#### 任务 2：实现 FloatingPanel 组件

**目标**：创建可拖拽、可调整大小的浮动面板

**核心功能**：

```typescript
// 面板配置接口
interface PanelConfig {
  visible: boolean; // 是否显示
  activeTab: string | null; // 当前激活的 Tab
  position: { x: number; y: number }; // 位置
  size: { width: number; height: number }; // 尺寸
  preset: "small" | "medium" | "large"; // 尺寸预设
}

// 尺寸预设
const sizePresets = {
  small: { width: 280, height: "100%" },
  medium: { width: 360, height: "100%" },
  large: { width: 480, height: "100%" },
};
```

**交互实现**：

1. **拖拽移动**：

   - 使用 VueUse 的 `useDraggable` 实现
   - 只能拖拽标题栏区域
   - 限制拖拽范围（不能超出视口）

2. **调整大小**：

   - 左边缘可拖拽调整宽度
   - 最小宽度 240px，最大宽度 600px
   - 显示调整光标提示

3. **关闭/展开**：
   - 标题栏右侧关闭按钮
   - 关闭时记住当前状态
   - 再次打开时恢复上次位置和尺寸

**面板内容渲染**：

```typescript
// 根据 activeTab 动态渲染内容
<component
  :is="getPanelComponent(activeTab)"
  v-if="visible && activeTab"
/>

// 内容组件映射
const panelComponents = {
  workflow: WorkflowTreePanel,
  nodes: NodeLibraryPanel,
  variables: VariableEditorPanel,
  history: HistoryPanel,
  test: TestMenuPanel,
  settings: SettingsPanel,
};
```

#### 任务 3：创建 TestMenuPanel 组件

**目标**：为开发调试提供便捷的测试界面

**UI 布局**：

```
┌─────────────────────────────┐
│  测试菜单                    │
├─────────────────────────────┤
│                             │
│  📦 弹窗测试                 │
│  ├─ 🔲 信息 Modal           │
│  ├─ 🔲 全屏编辑器            │
│  ├─ 🔲 确认对话框            │
│  └─ 🔲 提示消息              │
│                             │
│  📐 面板测试                 │
│  ├─ 🔲 Small 尺寸           │
│  ├─ 🔲 Medium 尺寸          │
│  ├─ 🔲 Large 尺寸           │
│  └─ 🔲 重置面板              │
│                             │
│  🎨 画布测试                 │
│  ├─ 🔲 添加测试节点          │
│  ├─ 🔲 模拟执行              │
│  ├─ 🔲 测试连线              │
│  └─ 🔲 清空画布              │
│                             │
│  💾 数据测试                 │
│  ├─ 🔲 加载示例工作流        │
│  ├─ 🔲 导出画布数据          │
│  └─ 🔲 重置所有状态          │
│                             │
│  🎭 UI 状态测试              │
│  ├─ 🔲 切换主题              │
│  ├─ 🔲 显示加载状态          │
│  ├─ 🔲 显示错误状态          │
│  └─ 🔲 显示空状态            │
│                             │
└─────────────────────────────┘
```

**功能实现**：

```typescript
// 测试方法定义
const testActions = {
  // 弹窗测试
  showInfoModal() {
    // 打开信息展示 Modal
  },
  showFullscreenEditor() {
    // 打开全屏代码编辑器 Modal
  },
  showConfirmDialog() {
    // 打开确认对话框
  },
  showToast() {
    // 显示提示消息
  },

  // 面板测试
  resizePanel(preset: "small" | "medium" | "large") {
    // 调整面板尺寸
  },
  resetPanel() {
    // 重置面板位置和尺寸
  },

  // 画布测试
  addTestNodes() {
    // 添加测试节点到画布
  },
  simulateExecution() {
    // 模拟工作流执行
  },
  testConnection() {
    // 测试节点连线
  },
  clearCanvas() {
    // 清空画布
  },

  // 数据测试
  loadSampleWorkflow() {
    // 加载示例工作流
  },
  exportCanvasData() {
    // 导出画布数据为 JSON
  },
  resetAllState() {
    // 重置所有状态
  },

  // UI 状态测试
  toggleTheme() {
    // 切换主题
  },
  showLoading() {
    // 显示加载状态
  },
  showError() {
    // 显示错误状态
  },
  showEmpty() {
    // 显示空状态
  },
};
```

#### 任务 4：创建 Modal 组件系统

**目标**：实现两种常用的 Modal 类型

**4.1 InfoModal（信息展示 Modal）**

```typescript
功能：
- 展示信息内容
- 支持自定义标题、内容、按钮
- 支持图标和颜色主题
- 支持关闭回调

使用场景：
- 显示节点详细信息
- 显示执行结果
- 显示帮助文档
```

**4.2 FullscreenEditorModal（全屏编辑器 Modal）**

```typescript
功能：
- 全屏代码编辑器
- 支持语法高亮（Monaco Editor / CodeMirror）
- 支持多种语言（JavaScript、JSON、YAML 等）
- 支持保存、取消、格式化

使用场景：
- 编辑节点代码逻辑
- 编辑工作流配置（JSON）
- 查看执行日志
```

**Modal 基础组件增强（ModalShell）**：

```typescript
// 新增功能
interface ModalShellProps {
  // 原有属性
  visible: boolean;
  title?: string;

  // 新增属性
  size?: "small" | "medium" | "large" | "fullscreen"; // 尺寸
  closeOnEsc?: boolean; // ESC 键关闭
  closeOnMask?: boolean; // 点击遮罩关闭
  showClose?: boolean; // 显示关闭按钮
  footer?: boolean; // 是否显示底部栏
  centered?: boolean; // 是否居中
  maskClosable?: boolean; // 遮罩层可关闭
}

// 尺寸预设
const modalSizes = {
  small: "max-w-sm",
  medium: "max-w-2xl",
  large: "max-w-4xl",
  fullscreen: "w-screen h-screen",
};
```

#### 任务 5：完善配置管理系统

**目标**：实现 JSON 驱动的配置 UI

**配置架构**：

```typescript
// 配置 Schema 定义
interface ConfigSchema {
  sections: ConfigSection[]; // 配置分组
}

interface ConfigSection {
  id: string;
  title: string;
  description?: string;
  icon?: Component;
  fields: ConfigField[];
}

interface ConfigField {
  key: string; // 配置键
  label: string; // 显示标签
  type: FieldType; // 字段类型
  default: any; // 默认值
  description?: string; // 描述
  required?: boolean; // 是否必填
  validation?: ValidationRule[]; // 验证规则
  options?: Option[]; // 选项（用于 select、radio）
  placeholder?: string; // 占位符
  disabled?: boolean; // 是否禁用
}

type FieldType =
  | "input" // 文本输入
  | "textarea" // 多行文本
  | "number" // 数字输入
  | "select" // 下拉选择
  | "switch" // 开关
  | "checkbox" // 复选框
  | "radio" // 单选框
  | "color" // 颜色选择器
  | "file" // 文件上传
  | "json-editor" // JSON 编辑器
  | "code-editor"; // 代码编辑器
```

**配置渲染器实现**：

```vue
<!-- ConfigRenderer.vue -->
<template>
  <div class="config-renderer">
    <div
      v-for="section in schema.sections"
      :key="section.id"
      class="config-section"
    >
      <div class="section-header">
        <component
          :is="section.icon"
          v-if="section.icon"
          class="section-icon"
        />
        <h3>{{ section.title }}</h3>
        <p v-if="section.description">{{ section.description }}</p>
      </div>

      <div class="section-fields">
        <ConfigField
          v-for="field in section.fields"
          :key="field.key"
          :field="field"
          :value="config[field.key]"
          @update:value="updateConfig(field.key, $event)"
        />
      </div>
    </div>
  </div>
</template>
```

**示例配置**：

```typescript
// 编辑器配置示例
const editorConfigSchema: ConfigSchema = {
  sections: [
    {
      id: "general",
      title: "常规设置",
      description: "编辑器基础配置",
      icon: IconSettings,
      fields: [
        {
          key: "theme",
          label: "主题",
          type: "select",
          default: "light",
          options: [
            { label: "亮色", value: "light" },
            { label: "暗色", value: "dark" },
            { label: "自动", value: "auto" },
          ],
        },
        {
          key: "autoSave",
          label: "自动保存",
          type: "switch",
          default: true,
          description: "自动保存工作流更改",
        },
        {
          key: "gridSize",
          label: "网格大小",
          type: "number",
          default: 20,
          validation: [
            { type: "min", value: 10 },
            { type: "max", value: 50 },
          ],
        },
      ],
    },
    {
      id: "execution",
      title: "执行设置",
      icon: IconPlay,
      fields: [
        {
          key: "executionMode",
          label: "执行模式",
          type: "radio",
          default: "worker",
          options: [
            { label: "Worker 模式", value: "worker" },
            { label: "Server 模式", value: "server" },
          ],
        },
        {
          key: "serverUrl",
          label: "Server 地址",
          type: "input",
          default: "http://localhost:3000",
          placeholder: "输入服务器地址",
          validation: [{ type: "url" }],
        },
      ],
    },
  ],
};
```

### 3.4 交付物清单

#### 代码交付物

```
src/newCode/
├── features/canvas/
│   ├── CanvasView.vue                    // ✅ 已完成（需增强）
│   └── components/
│       ├── VerticalTabNav.vue            // ✅ 已完成（需增强）
│       ├── FloatingPanel.vue             // ✅ 已完成（需增强）
│       ├── CanvasToolbar.vue             // ✅ 已完成
│       ├── QuickNodeMenu.vue             // ✅ 已完成
│       ├── NodeInfoCard.vue              // ✅ 已完成
│       ├── TestMenuPanel.vue             // 🔲 待创建
│       ├── InfoModal.vue                 // 🔲 待创建
│       └── FullscreenEditorModal.vue     // 🔲 待创建
│
├── components/ui/
│   ├── ModalShell.vue                    // ✅ 已完成（需增强）
│   ├── PanelShell.vue                    // ✅ 已完成
│   ├── ConfigRenderer.vue                // 🔲 待创建
│   └── ConfigField.vue                   // 🔲 待创建
│
├── config/
│   ├── tabs.ts                           // 🔲 待创建
│   ├── editorConfig.ts                   // 🔲 待创建
│   └── testMenu.ts                       // 🔲 待创建
│
└── stores/
    ├── canvas.ts                         // ✅ 已完成
    ├── ui.ts                             // 🔲 待创建
    └── config.ts                         // 🔲 待创建
```

#### 功能交付物

- [ ] 完整的侧边栏导航（支持 6 个 Tab 项）
- [ ] 可拖拽、可调整大小的浮动面板
- [ ] 测试菜单面板（包含 20+ 个测试按钮）
- [ ] 信息展示 Modal
- [ ] 全屏编辑器 Modal
- [ ] JSON 驱动的配置系统
- [ ] 配置渲染器组件

#### 文档交付物

- [ ] UI 组件使用文档（`重构文档/ui-components.md`）
- [ ] 测试菜单使用指南（`重构文档/test-menu-guide.md`）
- [ ] 配置系统文档（`重构文档/config-system.md`）
- [ ] 阶段 1 验收报告（`重构文档/stage1-report.md`）

### 3.5 验收标准

#### 功能验收

- [ ] 所有 Tab 项可正常切换
- [ ] 浮动面板可拖拽移动（不超出边界）
- [ ] 浮动面板可调整大小（240-600px）
- [ ] 浮动面板可关闭和重新打开
- [ ] 测试菜单所有按钮可点击并执行
- [ ] Modal 可正常打开、关闭
- [ ] 全屏编辑器支持代码高亮
- [ ] 配置系统可正常渲染和更新

#### 交互验收

- [ ] Tab 切换动画流畅（<100ms）
- [ ] 面板拖拽无卡顿
- [ ] Modal 打开/关闭动画自然
- [ ] 键盘快捷键响应及时
- [ ] 所有按钮有悬停反馈

#### 视觉验收

- [ ] 所有组件符合设计规范
- [ ] 颜色、字体、间距一致
- [ ] 图标清晰可辨
- [ ] 暗色模式适配良好
- [ ] 响应式布局正常

#### 性能验收

- [ ] 页面初始加载 < 2s
- [ ] Tab 切换响应时间 < 100ms
- [ ] Modal 打开时间 < 200ms
- [ ] 无明显内存泄漏
- [ ] 浏览器控制台无错误

---

## 四、阶段 2：核心画布逻辑实现

### 4.1 产品目标

**核心目标**：实现可用的节点编辑器核心功能，支持节点的创建、连接、配置和基础操作。

**成功标准**：

- ✅ 用户可以从节点库拖拽节点到画布
- ✅ 用户可以连接节点形成工作流
- ✅ 用户可以配置节点参数
- ✅ 用户可以保存和加载工作流
- ✅ 画布操作流畅，无明显卡顿

### 4.2 功能模块设计

#### 4.2.1 画布基础能力

**节点操作**：

- 拖拽添加：从节点库拖拽到画布创建节点
- 选择/多选：单击选中，Ctrl+单击多选，框选
- 移动：拖拽节点移动位置
- 删除：Delete 键或右键菜单删除
- 复制/粘贴：Ctrl+C/V 复制粘贴节点
- 撤销/重做：Ctrl+Z/Y 操作历史

**连线操作**：

- 拖拽连线：从输出端点拖拽到输入端点
- 删除连线：选中后 Delete 或右键删除
- 智能提示：连线时高亮可连接的端点
- 连线验证：检查类型兼容性

**画布操作**：

- 缩放：鼠标滚轮或工具栏按钮
- 平移：中键拖拽或空白处拖拽
- 框选：按住 Shift 拖拽框选
- 自适应：自动调整视图适应所有节点
- 自动布局：算法排列节点位置

**快捷键系统**：

```typescript
const shortcuts = {
  "Ctrl+S": "保存工作流",
  "Ctrl+Z": "撤销",
  "Ctrl+Shift+Z": "重做",
  "Ctrl+C": "复制",
  "Ctrl+V": "粘贴",
  "Ctrl+X": "剪切",
  "Ctrl+A": "全选",
  Delete: "删除",
  "Ctrl+F": "查找节点",
  Space: "打开快捷菜单",
  "Ctrl+/": "显示快捷键列表",
};
```

#### 4.2.2 节点库面板（NodeLibraryPanel）

**功能需求**：

```typescript
// 节点分类结构
interface NodeCategory {
  id: string;
  name: string;
  icon: Component;
  color: string;
  nodes: NodeDefinition[];
}

// 节点定义
interface NodeDefinition {
  id: string;
  name: string;
  description: string;
  category: string;
  icon?: Component;
  color?: string;
  tags?: string[];
  inputs: PortDefinition[];
  outputs: PortDefinition[];
  config: ConfigSchema;
}

// 端口定义
interface PortDefinition {
  id: string;
  name: string;
  type: "string" | "number" | "boolean" | "object" | "array" | "any";
  required: boolean;
  default?: any;
}
```

**UI 设计**：

```
┌─────────────────────────────┐
│  节点库                      │
├─────────────────────────────┤
│  🔍 搜索节点...              │
├─────────────────────────────┤
│  📂 浏览器操作 (5)           │
│  ├─ 🌐 打开网页              │
│  ├─ 👆 点击元素              │
│  ├─ ⌨️ 输入文本              │
│  ├─ 📸 截图                  │
│  └─ 📄 获取内容              │
│                             │
│  📂 数据处理 (8)             │
│  ├─ 🔄 数据转换              │
│  ├─ 🔍 数据过滤              │
│  ├─ 📊 数据聚合              │
│  └─ ...                     │
│                             │
│  📂 流程控制 (4)             │
│  ├─ 🔀 条件分支              │
│  ├─ 🔁 循环                  │
│  ├─ ⏸️ 等待                  │
│  └─ 🛑 终止                  │
│                             │
└─────────────────────────────┘
```

**交互行为**：

- 搜索：实时过滤节点列表
- 分类折叠/展开：手风琴模式
- 拖拽添加：拖拽节点到画布创建
- 双击添加：双击节点在画布中心创建
- 右键菜单：查看详情、添加到收藏

#### 4.2.3 节点配置面板（NodeConfigPanel）

**功能需求**：

```typescript
// 配置面板状态
interface NodeConfigState {
  selectedNodeId: string | null; // 选中的节点 ID
  nodeConfig: Record<string, any>; // 节点配置数据
  validationErrors: ValidationError[]; // 验证错误
  isDirty: boolean; // 是否有未保存的更改
}

// 表单字段组件映射
const fieldComponents = {
  input: FormInput,
  textarea: FormTextarea,
  number: FormNumber,
  select: FormSelect,
  switch: FormSwitch,
  checkbox: FormCheckbox,
  radio: FormRadioGroup,
  color: FormColorPicker,
  file: FormFileUpload,
  "json-editor": FormJsonEditor,
  "code-editor": FormCodeEditor,
};
```

**UI 设计**：

```
┌─────────────────────────────┐
│  节点配置                    │
│  打开网页                    │
├─────────────────────────────┤
│                             │
│  基础设置                    │
│  ┌─────────────────────┐    │
│  │ 节点名称              │    │
│  │ [打开百度首页______]  │    │
│  └─────────────────────┘    │
│                             │
│  ┌─────────────────────┐    │
│  │ URL                  │    │
│  │ [https://baidu.com_]  │    │
│  └─────────────────────┘    │
│                             │
│  高级选项                    │
│  ┌─────────────────────┐    │
│  │ ☑ 等待页面加载        │    │
│  │ ☐ 禁用 JavaScript    │    │
│  │ ☐ 移动端模式          │    │
│  └─────────────────────┘    │
│                             │
│  ┌─────────────────────┐    │
│  │ 超时时间 (秒)         │    │
│  │ [30________________]  │    │
│  └─────────────────────┘    │
│                             │
│  变量引用                    │
│  ┌─────────────────────┐    │
│  │ 🔗 插入变量           │    │
│  └─────────────────────┘    │
│                             │
│           [保存] [重置]      │
│                             │
└─────────────────────────────┘
```

**交互行为**：

- 实时验证：输入时验证字段
- 错误提示：显示验证错误信息
- 自动保存：配置更改自动保存（可选）
- 变量插入：支持拖拽或点击插入变量
- 预设模板：快速选择常用配置

#### 4.2.4 工作流树面板（WorkflowTreePanel）

**功能需求**：

```typescript
// 工作流树节点
interface WorkflowTreeNode {
  id: string;
  name: string;
  type: "folder" | "workflow";
  children?: WorkflowTreeNode[];
  metadata?: {
    createdAt: string;
    updatedAt: string;
    nodeCount?: number;
    tags?: string[];
  };
}

// 树操作
interface TreeOperations {
  create(parent: string, type: "folder" | "workflow"): void;
  rename(id: string, newName: string): void;
  move(id: string, targetId: string): void;
  delete(id: string): void;
  duplicate(id: string): void;
  export(id: string): void;
  import(file: File): void;
}
```

**UI 设计**：

```
┌─────────────────────────────┐
│  工作流                      │
├─────────────────────────────┤
│  🔍 搜索...                  │
│  [📁+] [📄+]                │
├─────────────────────────────┤
│  📁 我的工作流                │
│  ├─ 📄 数据采集流程          │
│  ├─ 📄 表单自动填写          │
│  └─ 📁 测试工作流            │
│      ├─ 📄 登录测试          │
│      └─ 📄 数据验证          │
│                             │
│  📁 模板库                   │
│  ├─ 📄 网页截图              │
│  ├─ 📄 数据抓取              │
│  └─ 📄 自动化测试            │
│                             │
│  📁 最近使用                 │
│  ├─ 📄 数据采集流程 (2h前)   │
│  └─ 📄 表单自动填写 (1d前)   │
│                             │
└─────────────────────────────┘
```

**交互行为**：

- 拖拽排序：拖拽节点调整顺序
- 拖拽移动：拖拽节点移动到其他文件夹
- 右键菜单：重命名、删除、复制、导出等
- 双击打开：双击工作流加载到画布
- 单击预览：单击显示工作流信息

### 4.3 服务层设计

#### 4.3.1 CanvasService

```typescript
/**
 * 画布服务
 * 负责管理画布的所有操作
 */
class CanvasService {
  // VueFlow 实例引用
  private vueFlowInstance: VueFlowStore | null = null;

  // 事件总线
  private eventBus = mitt<CanvasEvents>();

  // 初始化
  init(instance: VueFlowStore): void;

  // 节点操作
  addNode(node: NodeDefinition, position: Position): void;
  removeNode(nodeId: string): void;
  updateNode(nodeId: string, updates: Partial<Node>): void;
  getNode(nodeId: string): Node | undefined;
  getAllNodes(): Node[];

  // 连线操作
  addEdge(edge: EdgeDefinition): void;
  removeEdge(edgeId: string): void;
  getEdge(edgeId: string): Edge | undefined;
  getAllEdges(): Edge[];

  // 选择操作
  selectNode(nodeId: string, multi?: boolean): void;
  selectNodes(nodeIds: string[]): void;
  clearSelection(): void;
  getSelectedNodes(): Node[];

  // 视图操作
  fitView(options?: FitViewOptions): void;
  zoomIn(step?: number): void;
  zoomOut(step?: number): void;
  zoomTo(zoom: number): void;
  panTo(x: number, y: number): void;

  // 布局操作
  autoLayout(algorithm?: "dagre" | "force" | "tree"): void;
  alignNodes(direction: "left" | "right" | "top" | "bottom" | "center"): void;
  distributeNodes(direction: "horizontal" | "vertical"): void;

  // 历史操作
  undo(): void;
  redo(): void;
  canUndo(): boolean;
  canRedo(): boolean;

  // 快捷键
  registerShortcut(key: string, handler: () => void): void;
  unregisterShortcut(key: string): void;

  // 事件订阅
  on<K extends keyof CanvasEvents>(
    event: K,
    handler: (payload: CanvasEvents[K]) => void
  ): void;

  // 清理
  destroy(): void;
}
```

#### 4.3.2 NodeRegistryService

```typescript
/**
 * 节点注册服务
 * 负责管理节点定义和元数据
 */
class NodeRegistryService {
  // 节点缓存
  private nodeCache: Map<string, NodeDefinition> = new Map();

  // 分类缓存
  private categoryCache: Map<string, NodeCategory> = new Map();

  // 加载节点定义
  async loadNodes(): Promise<void>;

  // 获取所有节点
  getAllNodes(): NodeDefinition[];

  // 按分类获取节点
  getNodesByCategory(categoryId: string): NodeDefinition[];

  // 获取单个节点
  getNode(nodeId: string): NodeDefinition | undefined;

  // 搜索节点
  searchNodes(query: string): NodeDefinition[];

  // 获取所有分类
  getCategories(): NodeCategory[];

  // 获取节点颜色
  getNodeColor(nodeId: string): string;

  // 注册自定义节点
  registerNode(node: NodeDefinition): void;

  // 注销节点
  unregisterNode(nodeId: string): void;

  // 热更新
  async reloadNodes(): Promise<void>;
}
```

#### 4.3.3 WorkflowService

```typescript
/**
 * 工作流服务
 * 负责工作流的保存、加载和管理
 */
class WorkflowService {
  // 工作流缓存
  private workflows: Map<string, Workflow> = new Map();

  // 创建工作流
  async create(name: string, parentId?: string): Promise<Workflow>;

  // 加载工作流
  async load(workflowId: string): Promise<Workflow>;

  // 保存工作流
  async save(workflow: Workflow): Promise<void>;

  // 删除工作流
  async delete(workflowId: string): Promise<void>;

  // 重命名工作流
  async rename(workflowId: string, newName: string): Promise<void>;

  // 复制工作流
  async duplicate(workflowId: string): Promise<Workflow>;

  // 移动工作流
  async move(workflowId: string, targetParentId: string): Promise<void>;

  // 导出工作流
  async export(workflowId: string): Promise<Blob>;

  // 导入工作流
  async import(file: File): Promise<Workflow>;

  // 获取工作流树
  async getTree(): Promise<WorkflowTreeNode[]>;

  // 获取最近使用
  async getRecent(limit?: number): Promise<Workflow[]>;

  // 搜索工作流
  searchWorkflows(query: string): Workflow[];
}
```

### 4.4 交付物清单

#### 代码交付物

```
src/newCode/
├── features/
│   ├── canvas/
│   │   └── components/
│   │       ├── NodeLibraryPanel.vue      // 🔲 待创建
│   │       ├── NodeConfigPanel.vue       // 🔲 待创建
│   │       └── WorkflowTreePanel.vue     // 🔲 待创建
│   │
│   └── node-editor/                      // 🔲 待创建
│       ├── NodeEditor.vue                // 主编辑器组件
│       ├── CustomNode.vue                // 自定义节点组件
│       └── CustomEdge.vue                // 自定义连线组件
│
├── services/
│   ├── canvasService.ts                  // 🔲 待完善
│   ├── nodeRegistryService.ts            // 🔲 待创建
│   ├── workflowService.ts                // 🔲 待创建
│   └── historyService.ts                 // 🔲 待创建
│
└── stores/
    ├── canvas.ts                         // 🔲 待完善
    ├── workflow.ts                       // 🔲 待创建
    └── nodeLibrary.ts                    // 🔲 待创建
```

#### 功能交付物

- [ ] 完整的节点编辑器（基于 VueFlow）
- [ ] 节点库面板（支持搜索、分类、拖拽）
- [ ] 节点配置面板（JSON 驱动表单）
- [ ] 工作流树面板（支持 CRUD 和拖拽）
- [ ] 快捷键系统（20+ 个快捷键）
- [ ] 自动布局算法（Dagre 布局）
- [ ] 历史记录（撤销/重做）
- [ ] 工作流保存/加载

#### 文档交付物

- [ ] 画布操作文档（`重构文档/canvas-operations.md`）
- [ ] 节点开发指南（`重构文档/node-development.md`）
- [ ] 服务层 API 文档（`重构文档/service-api.md`）
- [ ] 阶段 2 验收报告（`重构文档/stage2-report.md`）

### 4.5 验收标准

#### 功能验收

- [ ] 可从节点库拖拽节点到画布
- [ ] 可连接节点形成工作流
- [ ] 可配置节点参数
- [ ] 可保存和加载工作流
- [ ] 撤销/重做功能正常
- [ ] 快捷键响应正常
- [ ] 自动布局算法有效

#### 交互验收

- [ ] 节点拖拽流畅（60 FPS）
- [ ] 连线操作顺滑
- [ ] 画布缩放平滑
- [ ] 节点选择反馈及时
- [ ] 右键菜单响应快速

#### 数据验收

- [ ] 工作流数据结构正确
- [ ] 保存/加载无数据丢失
- [ ] 导入/导出功能正常
- [ ] 数据验证有效

#### 性能验收

- [ ] 100 个节点画布无卡顿
- [ ] 节点拖拽延迟 < 16ms
- [ ] 自动布局耗时 < 1s
- [ ] 内存占用合理

---

## 五、阶段 3：配置系统与节点管理

### 5.1 产品目标

**核心目标**：完善节点配置系统，实现动态表单渲染和变量引用功能。

**成功标准**：

- ✅ 支持 JSON Schema 驱动的配置表单
- ✅ 支持变量引用和插值
- ✅ 支持配置验证和错误提示
- ✅ 支持配置模板和预设

### 5.2 功能设计

（详细内容待展开...）

---

## 六、阶段 4：执行引擎重构

### 6.1 产品目标

**核心目标**：重构执行引擎，实现事件驱动的状态更新，移除轮询机制。

**成功标准**：

- ✅ 执行状态实时更新（无轮询）
- ✅ 支持 Worker / Server 双模式
- ✅ 支持执行暂停/恢复/取消
- ✅ 支持执行日志和错误追踪

### 6.2 功能设计

（详细内容待展开...）

---

## 七、阶段 5：数据迁移与优化

### 7.1 产品目标

**核心目标**：完成数据迁移，优化性能，准备上线。

**成功标准**：

- ✅ 旧数据成功迁移到新系统
- ✅ 性能指标达标
- ✅ 所有功能回归测试通过
- ✅ 文档完善

### 7.2 功能设计

（详细内容待展开...）

---

## 八、项目管理

### 8.1 开发流程

```
需求确认 → 设计评审 → 开发实现 → 自测 → 提测 → 回归测试 → 发布
```

### 8.2 质量保证

#### 代码规范

- ESLint + TypeScript 严格模式
- 代码审查（Code Review）
- 单元测试覆盖率 > 70%

#### 测试策略

- 单元测试：关键逻辑和服务层
- 集成测试：服务间交互
- E2E 测试：核心用户路径
- 性能测试：关键操作性能基准

#### 文档规范

- 组件文档：Props、Events、Slots
- 服务文档：API、使用示例
- 用户文档：功能说明、操作指南

### 8.3 风险管理

| 风险等级 | 风险描述         | 应对措施               |
| -------- | ---------------- | ---------------------- |
| 🔴 高    | 核心功能实现困难 | 提前技术验证，备选方案 |
| 🟡 中    | 性能不达标       | 性能监控，及时优化     |
| 🟡 中    | 数据迁移失败     | 充分测试，备份机制     |
| 🟢 低    | UI 不符合预期    | 早期原型验证，快速迭代 |

### 8.4 进度跟踪

| 阶段   | 开始日期   | 预计完成   | 实际完成   | 状态      |
| ------ | ---------- | ---------- | ---------- | --------- |
| 阶段 0 | 2025-11-04 | 2025-11-05 | 2025-11-05 | ✅ 已完成 |
| 阶段 1 | 2025-11-05 | 2025-11-12 | -          | 🔄 进行中 |
| 阶段 2 | 2025-11-12 | 2025-11-26 | -          | ⏸️ 未开始 |
| 阶段 3 | 2025-11-26 | 2025-12-10 | -          | ⏸️ 未开始 |
| 阶段 4 | 2025-12-10 | 2025-12-24 | -          | ⏸️ 未开始 |
| 阶段 5 | 2025-12-24 | 2026-01-07 | -          | ⏸️ 未开始 |

---

## 九、用户体验设计原则

### 9.1 易用性原则

1. **降低学习成本**：

   - 提供新手引导
   - 常用操作一键完成
   - 快捷键提示

2. **即时反馈**：

   - 操作后立即提供视觉反馈
   - 错误信息清晰友好
   - 加载状态明确

3. **容错设计**：
   - 支持撤销/重做
   - 自动保存
   - 操作确认对话框

### 9.2 包容性设计

1. **无障碍支持**：

   - 键盘导航
   - ARIA 标签
   - 语音辅助

2. **多设备适配**：

   - 响应式布局
   - 触摸屏优化
   - 不同分辨率适配

3. **国际化支持**：
   - 多语言切换
   - 时区处理
   - 货币格式

### 9.3 情感化设计

1. **视觉愉悦**：

   - 流畅动画
   - 舒适配色
   - 清晰图标

2. **成就感**：

   - 进度提示
   - 完成庆祝
   - 使用统计

3. **人性化关怀**：
   - 友好的文案
   - 贴心的提示
   - 智能的建议

---

## 十、总结

### 10.1 核心变化

| 对比项   | 原计划     | 新方案         |
| -------- | ---------- | -------------- |
| **起点** | Shell 组件 | 完整 UI 布局   |
| **交付** | 预览页面   | 可用产品功能   |
| **验证** | 阶段结束后 | 每个功能完成后 |
| **重点** | 技术架构   | 用户体验       |

### 10.2 预期收益

1. **开发效率**：

   - 快速看到成果，提升士气
   - 及时发现问题，减少返工
   - 垂直切片，降低复杂度

2. **产品质量**：

   - 早期用户反馈，快速迭代
   - 完整功能验证，降低风险
   - 持续集成，保证稳定性

3. **用户价值**：
   - 尽早交付可用功能
   - 持续优化用户体验
   - 建立用户信任

### 10.3 下一步行动

**立即开始（阶段 1）**：

1. ✅ **增强 VerticalTabNav**：

   - 添加 6 个 Tab 项配置
   - 实现点击切换逻辑
   - 添加角标和禁用状态

2. ✅ **完善 FloatingPanel**：

   - 实现拖拽移动功能
   - 实现尺寸调整功能
   - 实现关闭/展开逻辑

3. ✅ **创建 TestMenuPanel**：

   - 设计测试菜单 UI
   - 实现 20+ 个测试按钮
   - 对接各个测试方法

4. ✅ **创建 Modal 组件**：

   - 实现 InfoModal
   - 实现 FullscreenEditorModal
   - 增强 ModalShell

5. ✅ **创建配置系统**：
   - 设计 Config Schema
   - 实现 ConfigRenderer
   - 实现 ConfigField

---

## 附录

### A. 参考资料

- [GPT Codex 方案](./gpt-codex.md)
- [原重构计划](./重构计划.md)
- [实施日志](./implementation-log.md)
- [目录结构说明](./directory-structure.md)

### B. 设计稿

- `工作流 + 画布.png` - 完整布局
- `节点列表 + 画布.png` - 节点库
- `节点配置.png` - 节点配置
- `编辑器配置 + 画布.png` - 编辑器配置
- `代码编辑器.png` - 代码编辑器

### C. 术语表

| 术语         | 说明                       |
| ------------ | -------------------------- |
| Canvas       | 画布，节点编辑器的主要区域 |
| Node         | 节点，工作流的基本单元     |
| Edge         | 连线，连接节点的线         |
| Port         | 端口，节点的输入/输出点    |
| Schema       | 模式，配置的结构定义       |
| Feature Flag | 特性开关，控制新功能启用   |

---

**文档维护**：本文档将随项目进展持续更新，请定期查阅最新版本。
